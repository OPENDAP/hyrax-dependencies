
# Build the hyrax-dependencies repo and snapshot that build if it works. This also builds
# static versions of the dependencies for use with the rpm builds of the BES.
#
# jhrg 2/23/18
#
# NB: Since the STARE library is part of our research work, include it in the 'travis'
# deps build and in the C7 version of the static deps. Don't include it in the C6 deps
# build since C++-11 is not part of C6 by default. We're leaving STARE out of the Debian
# package build for now as well. jhrg 10/28/19
#
# I removed CentOS 6 from our packages (10/27/20) since it is going to stop having
# maintenance releases in November 2020. jhrg
#
# I removed the Ubuntu/deb build because we're not using it. jhrg 12/08/20

# virt: lxd             # use an lxd container
arch: amd64           # optional, this is default, routes to a full VM
os: linux             # optional, this is default
dist: xenial          # or bionic | xenial | trusty | precise with xenial as default
vm:
  size: x-large       # options: large, x-large, 2x-large. These are EC2 instances. Default is 'medium'
                      # which is 2 vCPUs and 4 to 8 GB. Each size up from the default is 2x more

language: shell

compiler: gcc

branches:
  only:
    - master

addons:
  apt:
    packages:
      - uuid-dev
      - libxml2-dev
      - libcurl4-openssl-dev
      - libcppunit-dev
      - libicu-dev
      - libsqlite3-dev

env:
  global:
    - prefix=$HOME/install
    # AWS_ACCESS_KEY_ID (user: travis-hyrax-dependencies)
    - secure: "KDHpyQLB4nARPv/k4wUjgl6OD3jLMRifRwX58YFESvbU4IGB1pKS6sV0h4p5grdBBLikLYF7S61a2HhZ3b0zYADWzNEsDNwS3HDlhqVGVv53uanUy+6yTR7igkclh8zqw1dxzM9rbHtxB9TPIhq+gI0KpXXfMf+eP26SEuaiAWs="
    # AWS_SECRET_ACCESS_KEY
    - secure: "hEaItJDLc8Qrq6U2eZBVjpZKRDsCe2wSBjGA46mPkHsmeKFjP/1lG5qZ2+DdmC3+2/ZgM4iIRpTE6cqTaIjrd+6E6b8Dkgxwu1aQlEJRkuxbOJqyHrgjCob23Xq5ieXa+rS7TlDIdnYJnS8uCWWCr+cuZw8cMVUaqu1uNLY0EZQ="
    # DOCKER_HUB_UID for travis (travis encrypt --org -r OPENDAP/hyrax-dependencies DOCKER_HUB_UID=...)
    - secure: "HRdhqhsz9onm6OLMWoj9rjRFbTU+K6XAMuv69lwFEun3ECIvdb69lM2a2SCpX/NYdRmy5eYkK5mjkW0THLRaBthTDyAqXQSd8D/2Ge9Rx4KXLi0jA+FcA5OmOgy29ysAe0Ryp96UWb6UO4vv0f9jVoHGsbsakb37JN+bGHQD/nc="
    # DOCKER_HUB_PSWD for travis
    - secure: "Ney6w+mu5WNkBkiRv9W3rAfx10nBQkdRkhmxIfuuidO8eCrpF4E6KfcRUQcuaZJr6J2LANQx7MQ9bquEE7+hzn8s6Mi7Yd1KLKKCQ+ZN9J2wsvU5CdY8WeizF9iQwtQaKZq1xMcSiOxgNpHiqJ20oGTP4yKVYqGjG32+SPzVAYo="

before_install:
  # added because without this the docker pulls were failing for repeated builds
  - echo $DOCKER_HUB_PSWD | docker login -u $DOCKER_HUB_UID --password-stdin

stages:
  - name: build
    if: branch = master

jobs:
  include:
  - stage: build
    script:
      - make -j16 ci-part-1
      - make -j16 ci-part-2
      - make -j16 ci-part-3
      - make -j16 ci-part-4
      - export ARTIFACT=ubuntu

  - stage: build
    script:
      # mkdir returns true if the directory already exists. This dir is used in 'before_deploy'
      - mkdir -p $HOME/centos7/install
      # build-for-centos7.sh add sqlite-devel to the c7 image to build proj, a dep of gdal
      - docker run --volume $HOME/centos7/install:/root/install --volume $TRAVIS_BUILD_DIR:/root/hyrax-dependencies
          opendap/centos7_hyrax_builder:1.4 /root/hyrax-dependencies/build-for-centos7.sh
      - export ARTIFACT=centos7

# The before_deploy and deploy parts are run after every 'build' script completes. This section
# checks environment variables that are flags from the build stages. Note that the 'condition'
# in the 'deploy' section seems to control whether this section is run after any given stage. jhrg 1/12/22
before_deploy:
  - mkdir -p $TRAVIS_BUILD_DIR/package
  - if test -n $ARTIFACT -a $ARTIFACT = ubuntu;
    then tar -C $HOME -czf $TRAVIS_BUILD_DIR/package/hyrax-dependencies-build.tar.gz install;
    fi
  - if test -n $ARTIFACT -a $ARTIFACT = centos7;
    then tar -C $HOME/centos7/ -czf $TRAVIS_BUILD_DIR/package/hyrax-dependencies-centos7-static.tar.gz install;
    fi

deploy:
  provider: s3
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  bucket: opendap.travis.build
  local_dir: $TRAVIS_BUILD_DIR/package
  # The documentation says we don't need 'skip_cleanup', but as of 1/12/22, we do. jhrg
  skip_cleanup: true
  on:
    branch: master
    condition: $ARTIFACT =~ ^ubuntu|centos7$

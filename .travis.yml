
# Build the hyrax-dependencies repo and snapshot that build if it works. This also builds
# static versions of the dependencies for use with the rpm builds of the BES.
#
# jhrg 2/23/18
#
# NB: Since the STARE library is part of our research work, include it in the 'travis'
# deps build and in the C7 version of the static deps. Don't include it in the C6 deps
# build since C++-11 is not part of C6 by default. We're leaving STARE out of the Debian
# package build for now as well. jhrg 10/28/19
#

dist: focal             # or bionic | xenial | trusty | precise | focal with xenial as default

vm:
  size: 2x-large       # options: large, x-large, 2x-large. These are EC2 instances. Default is 'medium'
                      # which is 2 vCPUs and 4 to 8 GB. Each size up from the default is 2x more

# Using 'shell' here causes a problem down in the 'deploy' section with loading a particular
# version of Ruby. jhrg 1/5/24
#
#
language: cpp

compiler: gcc

branches:
  only:
    - master
    - main
    - /^(.*-test-deploy)$/

addons:
  apt:
    packages:
      - uuid-dev
      - libxml2-dev
      - libcurl4-openssl-dev
      - libcurl4
      - libcppunit-dev
      - libicu-dev
      - libsqlite3-dev

stages:
  - name: build
    if: branch = master OR branch = main OR branch =~ ^(.*-test-deploy)$
  - name: never
    if: branch = never

env:
  global:
    - EXPECTED_DEPS_COUNT=12
    - TIMEOUT=1000

jobs:
  include:
  - stage: build
    name: "ubuntu-focal"
    script:
      - echo "# ubuntu-focal - Expecting to build and install $EXPECTED_DEPS_COUNT dependencies." >&2
      - export prefix=$HOME/install
      - echo "# ubuntu-focal - prefix '$prefix'" >&2
      - export extra_targets="aws_s2n_tls"
      - echo "# ubuntu-focal - extra_targets '$extra_targets'" >&2
      - export EXPECTED_DEPS_COUNT=12
      - echo "# ubuntu-focal - Expecting to build and install $EXPECTED_DEPS_COUNT dependencies." >&2
      - make -j16 for-travis
      - make list-built
      - export ARTIFACT=ubuntu
      - mkdir -vp $TRAVIS_BUILD_DIR/package
      - export tarball_numbered="$TRAVIS_BUILD_DIR/package/hyrax-dependencies-build-$TRAVIS_BUILD_NUMBER.tgz"
      - echo "# ubuntu-focal - tarball_numbered '$tarball_numbered'" >&2
      - export tarball_latest="$TRAVIS_BUILD_DIR/package/hyrax-dependencies-build.tgz"
      - echo "# ubuntu-focal - tarball_latest '$tarball_latest'" >&2
      - tar -C "$HOME" -czvf "$tarball_numbered" install
      - cp -v "$tarball_numbered" "$tarball_latest"
      - ./travis/check-installed $EXPECTED_DEPS_COUNT

    # mkdir returns true if the directory already exists. This dir is used in 'before_deploy'.
  - stage: build
    name: "rocky8"
    script:
      - export ARTIFACT="rocky8"
      - echo "# $ARTIFACT - Expecting to build and install $EXPECTED_DEPS_COUNT dependencies." >&2
      - export extra_targets=""
      - echo "# $ARTIFACT - extra_targets '$extra_targets'" >&2
      - install_dir="$HOME/$ARTIFACT/install"
      - echo "# $ARTIFACT - install_dir '$install_dir'" >&2
      - mkdir -vp "$install_dir"
      - docker run 
        --env prefix=/root/install
        --env BUILD_NUMBER="$TRAVIS_BUILD_NUMBER"
        --volume $install_dir:/root/install 
        --volume $TRAVIS_BUILD_DIR:/root/hyrax-dependencies 
        opendap/rocky8_hyrax_builder:latest 
        /root/hyrax-dependencies/travis/build-for-rocky8.sh
      - export tarball_numbered="$TRAVIS_BUILD_DIR/package/hyrax-dependencies-$ARTIFACT-static-$TRAVIS_BUILD_NUMBER.tgz"
      - echo "# $ARTIFACT - tarball_numbered '$tarball_numbered'" >&2
      - export tarball_latest="$TRAVIS_BUILD_DIR/package/hyrax-dependencies-$ARTIFACT-static.tgz"
      - echo "# $ARTIFACT - tarball_latest '$tarball_latest'" >&2
      - mkdir -vp $TRAVIS_BUILD_DIR/package
      - tar -C "$HOME/$ARTIFACT/" -czvf "$tarball_numbered" install
      - cp -v "$tarball_numbered" "$tarball_latest"
      - ./travis/check-installed $EXPECTED_DEPS_COUNT
      - ls -l  $TRAVIS_BUILD_DIR/package/

  - stage: build
    name: "rocky9"
    script:
      - export ARTIFACT="rocky9"
      - echo "# $ARTIFACT - Expecting to build and install $EXPECTED_DEPS_COUNT dependencies." >&2
      - export extra_targets=""
      - echo "# $ARTIFACT - extra_targets '$extra_targets'" >&2
      - install_dir="$HOME/$ARTIFACT/install"
      - echo "# $ARTIFACT - install_dir '$install_dir'" >&2
      - mkdir -vp $"install_dir"
      - docker run 
        --env prefix=/root/install 
        --env BUILD_NUMBER="$TRAVIS_BUILD_NUMBER"
        --volume $install_dir:/root/install 
        --volume $TRAVIS_BUILD_DIR:/root/hyrax-dependencies 
        opendap/rocky9_hyrax_builder:latest 
        /root/hyrax-dependencies/travis/build-for-rocky9.sh
      - export tarball_numbered="$TRAVIS_BUILD_DIR/package/hyrax-dependencies-$ARTIFACT-static-$TRAVIS_BUILD_NUMBER.tgz"
      - echo "# $ARTIFACT - tarball_numbered '$tarball_numbered'" >&2
      - export tarball_latest="$TRAVIS_BUILD_DIR/package/hyrax-dependencies-$ARTIFACT-static.tgz"
      - echo "# $ARTIFACT - tarball_latest '$tarball_latest'" >&2
      - mkdir -vp $TRAVIS_BUILD_DIR/package
      - tar -C "$HOME/$ARTIFACT/" -czvf "$tarball_numbered" install
      - cp -v "$tarball_numbered" "$tarball_latest"
      - ./travis/check-installed $EXPECTED_DEPS_COUNT
      - ls -l  $TRAVIS_BUILD_DIR/package/

deploy:
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    bucket: opendap.travis.build
    local_dir: $TRAVIS_BUILD_DIR/package
    # The documentation says we don't need 'skip_cleanup', but as of 1/12/22, we do. jhrg
    skip_cleanup: true
    on:
      all_branches: true
      # Was "branch: master". Now supports the *-test-deploy feature and also
      # using 'main' as the branch name. jhrg 1/5/24
      condition: $ARTIFACT =~ ^ubuntu|rocky8|rocky9$


# Build the hyrax-dependencies repo and snapshot that build if it works. This also builds
# static versions of the dependencies for use with the rpm builds of the BES.
#
# jhrg 2/23/18
#
# NB: Since the STARE library is part of our research work, include it in the 'travis'
# deps build and in the C7 version of the static deps. Don't include it in the C6 deps
# build since C++-11 is not part of C6 by default. We're leaving STARE out of the Debian
# package build for now as well. jhrg 10/28/19

dist: trusty

sudo: false

language: cpp

compiler: gcc

branches:
  only:
  - master
  - travis

addons:
  apt:
    packages:
    - uuid-dev
    - libxml2-dev
    - libcurl4-openssl-dev
    - libcppunit-dev
    - libicu-dev

env:
  global:
  - prefix=$HOME/install

before_install: skip

stages:
  - name: build
    if:  branch = master
  - name: package
    if:  branch = master
  - name: travis
    if:  branch = travis

jobs:
  include:
  - stage: build
    script:
    - export DEPS_BUILD=travis
    - make -j7 for-travis BUILD_STARE=yes
  - stage: package
    script:
    - export DEPS_BUILD=ubuntu14
    - mkdir -p $HOME/ubuntu14/install
    - docker run --volume $HOME/ubuntu14/install:/root/install --volume $TRAVIS_BUILD_DIR:/root/hyrax-dependencies
             opendap/ubuntu14_hyrax_build:1.4 /root/hyrax-dependencies/build-for-deb.sh
  - stage: package
    script: 
    - export DEPS_BUILD=centos6
    - mkdir -p $HOME/centos6/install
    - docker run --volume $HOME/centos6/install:/root/install --volume $TRAVIS_BUILD_DIR:/root/hyrax-dependencies
             opendap/centos6_hyrax_builder:1.1 /root/hyrax-dependencies/build-for-rpm.sh
  - stage: package
    script: 
    - export DEPS_BUILD=centos7
    - mkdir -p $HOME/centos7/install
    # Note that for CentOS7, we build the dependencies so that STARE is included (but not for C6 or Debian)
    # The Makefile checks the value of the env var $BUILD_STARE. jhrg 10/28/19
    - docker run --env BUILD_STARE=yes --volume $HOME/centos7/install:/root/install --volume $TRAVIS_BUILD_DIR:/root/hyrax-dependencies
             opendap/centos7_hyrax_builder:1.1 /root/hyrax-dependencies/build-for-rpm.sh
  - stage: travis
      script: export DEPS_BUILD=travis

# before_deploy will be run once for every job stage/script that completes
before_deploy:
- mkdir -p $TRAVIS_BUILD_DIR/package
- if test "x$DEPS_BUILD" = "xtravis"; then tar -C $HOME -czvf $TRAVIS_BUILD_DIR/package/hyrax-dependencies-build.tar.gz install; fi
- if test "x$DEPS_BUILD" = "xubuntu14"; then tar -C $HOME/ubuntu14/ -czvf $TRAVIS_BUILD_DIR/package/hyrax-dependencies-ubuntu14-static.tar.gz install; fi
- if test "x$DEPS_BUILD" = "xcentos6"; then tar -C $HOME/centos6/ -czvf $TRAVIS_BUILD_DIR/package/hyrax-dependencies-centos6-static.tar.gz install; fi
- if test "x$DEPS_BUILD" = "xcentos7"; then tar -C $HOME/centos7/ -czvf $TRAVIS_BUILD_DIR/package/hyrax-dependencies-centos7-static.tar.gz install; fi
- if test "x$DEPS_BUILD" = "travis"; then cp $TRAVIS_BUILD_DIR/README $TRAVIS_BUILD_DIR/package/README; fi

deploy:
  provider: s3
  access_key_id: AKIA24JBYMSHQSFWAUM2
  secret_access_key:
    secure: "UlEtUtl2oWWPbp3Ef6MZI8WXKefsZiil3ElhibFcM/ephhxcIrQFlsSH4sLgJxEc9HhZ2IEuzRkgzmd0WOVYQyPvBZc/ReQtAsCiLwSBHZFxmqtNdB81XtSUwdSXBgG/knKeNjBdEXXT707+Q/W4+k7dDL28azjW93LS0iAxqC4="
    # old secure: WJD2mU3sHhDU79plgjcYsAbMiHJ4Nld37H3ha1ODifRwbKNUnMYKRfXOs4EgwxNnvG1mjood/MgDJRB4Aip760ELA8MuXHQOiPtBWUTztj540QXbYbkslmI3Wa6KON6Uq+l9EZ4/RLFpQjSrN2oZ0+ZsuMEvFNfszeI6txbnbjU=
  bucket: opendap.travis.build
  skip_cleanup: true
  local_dir: $TRAVIS_BUILD_DIR/package
  on:
    # Change to travis for testing; master for ops
    branch: travis
